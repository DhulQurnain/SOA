<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: Msf::Exploit::Remote::SMB::Server
  
    &mdash; Documentation by YARD 0.8.7.6
  
</title>

  <link rel="stylesheet" href="../../../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../../../';
  framesUrl = "../../../../frames.html#!Msf/Exploit/Remote/SMB/Server.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../../../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../../Msf.html" title="Msf (module)">Msf</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../../Exploit.html" title="Msf::Exploit (class)">Exploit</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Remote.html" title="Msf::Exploit::Remote (class)">Remote</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../SMB.html" title="Msf::Exploit::Remote::SMB (module)">SMB</a></span></span>
     &raquo; 
    <span class="title">Server</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Module: Msf::Exploit::Remote::SMB::Server
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
      <dt class="r1">Includes:</dt>
      <dd class="r1"><span class='object_link'><a href="../../NTLM.html" title="Msf::Exploit::NTLM (module)">NTLM</a></span>, <span class='object_link'><a href="../TcpServer.html" title="Msf::Exploit::Remote::TcpServer (module)">TcpServer</a></span></dd>
      
    
  
  
    <dt class="r2">Included in:</dt>
    <dd class="r2"><span class='object_link'><a href="Server/Share.html" title="Msf::Exploit::Remote::SMB::Server::Share (module)">Share</a></span></dd>
    
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/msf/core/exploit/smb/server.rb<span class="defines">,<br />
  lib/msf/core/exploit/smb/server/share.rb,<br /> lib/msf/core/exploit/smb/server/share/command.rb,<br /> lib/msf/core/exploit/smb/server/share/command/close.rb,<br /> lib/msf/core/exploit/smb/server/share/command/trans2.rb,<br /> lib/msf/core/exploit/smb/server/share/information_level.rb,<br /> lib/msf/core/exploit/smb/server/share/command/negotiate.rb,<br /> lib/msf/core/exploit/smb/server/share/command/read_andx.rb,<br /> lib/msf/core/exploit/smb/server/share/information_level/find.rb,<br /> lib/msf/core/exploit/smb/server/share/command/nt_create_andx.rb,<br /> lib/msf/core/exploit/smb/server/share/information_level/query.rb,<br /> lib/msf/core/exploit/smb/server/share/command/session_setup_andx.rb,<br /> lib/msf/core/exploit/smb/server/share/command/trans2/find_first2.rb,<br /> lib/msf/core/exploit/smb/server/share/command/trans2/query_path_information.rb,<br /> lib/msf/core/exploit/smb/server/share/command/trans2/query_file_information.rb</span>
</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>This mixin provides a minimal SMB server</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="Server/Share.html" title="Msf::Exploit::Remote::SMB::Server::Share (module)">Share</a></span>
    
  
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="CONST-constant" class="">CONST =
          
        </dt>
        <dd><pre class="code"><span class='op'>::</span><span class='const'>Rex</span><span class='op'>::</span><span class='const'>Proto</span><span class='op'>::</span><span class='const'>SMB</span><span class='op'>::</span><span class='const'>Constants</span></pre></dd>
      
        <dt id="CRYPT-constant" class="">CRYPT =
          
        </dt>
        <dd><pre class="code"><span class='op'>::</span><span class='const'>Rex</span><span class='op'>::</span><span class='const'>Proto</span><span class='op'>::</span><span class='const'>SMB</span><span class='op'>::</span><span class='const'>Crypt</span></pre></dd>
      
        <dt id="UTILS-constant" class="">UTILS =
          
        </dt>
        <dd><pre class="code"><span class='op'>::</span><span class='const'>Rex</span><span class='op'>::</span><span class='const'>Proto</span><span class='op'>::</span><span class='const'>SMB</span><span class='op'>::</span><span class='const'>Utils</span></pre></dd>
      
        <dt id="XCEPT-constant" class="">XCEPT =
          
        </dt>
        <dd><pre class="code"><span class='op'>::</span><span class='const'>Rex</span><span class='op'>::</span><span class='const'>Proto</span><span class='op'>::</span><span class='const'>SMB</span><span class='op'>::</span><span class='const'>Exceptions</span></pre></dd>
      
        <dt id="EVADE-constant" class="">EVADE =
          
        </dt>
        <dd><pre class="code"><span class='op'>::</span><span class='const'>Rex</span><span class='op'>::</span><span class='const'>Proto</span><span class='op'>::</span><span class='const'>SMB</span><span class='op'>::</span><span class='const'>Evasions</span></pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="../../NTLM.html" title="Msf::Exploit::NTLM (module)">NTLM</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../../NTLM.html#NTLM_BASE-constant" title="Msf::Exploit::NTLM::NTLM_BASE (constant)">NTLM::NTLM_BASE</a></span>, <span class='object_link'><a href="../../NTLM.html#NTLM_CONST-constant" title="Msf::Exploit::NTLM::NTLM_CONST (constant)">NTLM::NTLM_CONST</a></span>, <span class='object_link'><a href="../../NTLM.html#NTLM_CRYPT-constant" title="Msf::Exploit::NTLM::NTLM_CRYPT (constant)">NTLM::NTLM_CRYPT</a></span>, <span class='object_link'><a href="../../NTLM.html#NTLM_MESSAGE-constant" title="Msf::Exploit::NTLM::NTLM_MESSAGE (constant)">NTLM::NTLM_MESSAGE</a></span>, <span class='object_link'><a href="../../NTLM.html#NTLM_UTILS-constant" title="Msf::Exploit::NTLM::NTLM_UTILS (constant)">NTLM::NTLM_UTILS</a></span></p>




  <h2>Instance Attribute Summary</h2>
  
  <h3 class="inherited">Attributes included from <span class='object_link'><a href="../TcpServer.html" title="Msf::Exploit::Remote::TcpServer (module)">TcpServer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../TcpServer.html#service-instance_method" title="Msf::Exploit::Remote::TcpServer#service (method)">#service</a></span></p>


  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Object) <strong>initialize</strong>(info = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#on_client_close-instance_method" title="#on_client_close (instance method)">- (Object) <strong>on_client_close</strong>(client) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#on_client_connect-instance_method" title="#on_client_connect (instance method)">- (Object) <strong>on_client_connect</strong>(client) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#on_client_data-instance_method" title="#on_client_data (instance method)">- (Object) <strong>on_client_data</strong>(client) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#setup-instance_method" title="#setup (instance method)">- (Object) <strong>setup</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#smb_cmd_dispatch-instance_method" title="#smb_cmd_dispatch (instance method)">- (Object) <strong>smb_cmd_dispatch</strong>(cmd, c, buff) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#smb_conn-instance_method" title="#smb_conn (instance method)">- (Object) <strong>smb_conn</strong>(c) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#smb_error-instance_method" title="#smb_error (instance method)">- (Object) <strong>smb_error</strong>(cmd, c, errorclass, esn = false) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#smb_pool_update-instance_method" title="#smb_pool_update (instance method)">- (Object) <strong>smb_pool_update</strong>(c) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Update the last-seen timestamp and purge old entries.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#smb_recv-instance_method" title="#smb_recv (instance method)">- (Object) <strong>smb_recv</strong>(c) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#smb_set_defaults-instance_method" title="#smb_set_defaults (instance method)">- (Object) <strong>smb_set_defaults</strong>(c, pkt) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#smb_stop-instance_method" title="#smb_stop (instance method)">- (Object) <strong>smb_stop</strong>(c) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../TcpServer.html" title="Msf::Exploit::Remote::TcpServer (module)">TcpServer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../TcpServer.html#cleanup-instance_method" title="Msf::Exploit::Remote::TcpServer#cleanup (method)">#cleanup</a></span>, <span class='object_link'><a href="../TcpServer.html#exploit-instance_method" title="Msf::Exploit::Remote::TcpServer#exploit (method)">#exploit</a></span>, <span class='object_link'><a href="../TcpServer.html#primer-instance_method" title="Msf::Exploit::Remote::TcpServer#primer (method)">#primer</a></span>, <span class='object_link'><a href="../TcpServer.html#regenerate_payload-instance_method" title="Msf::Exploit::Remote::TcpServer#regenerate_payload (method)">#regenerate_payload</a></span>, <span class='object_link'><a href="../TcpServer.html#srvhost-instance_method" title="Msf::Exploit::Remote::TcpServer#srvhost (method)">#srvhost</a></span>, <span class='object_link'><a href="../TcpServer.html#srvport-instance_method" title="Msf::Exploit::Remote::TcpServer#srvport (method)">#srvport</a></span>, <span class='object_link'><a href="../TcpServer.html#ssl-instance_method" title="Msf::Exploit::Remote::TcpServer#ssl (method)">#ssl</a></span>, <span class='object_link'><a href="../TcpServer.html#ssl_cert-instance_method" title="Msf::Exploit::Remote::TcpServer#ssl_cert (method)">#ssl_cert</a></span>, <span class='object_link'><a href="../TcpServer.html#ssl_compression-instance_method" title="Msf::Exploit::Remote::TcpServer#ssl_compression (method)">#ssl_compression</a></span>, <span class='object_link'><a href="../TcpServer.html#start_service-instance_method" title="Msf::Exploit::Remote::TcpServer#start_service (method)">#start_service</a></span>, <span class='object_link'><a href="../TcpServer.html#stop_service-instance_method" title="Msf::Exploit::Remote::TcpServer#stop_service (method)">#stop_service</a></span></p>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt>Object</tt>) <strong>initialize</strong>(info = {}) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>super</span>

  <span class='id identifier rubyid_deregister_options'>deregister_options</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SSL</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SSLCert</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_register_options'>register_options</span><span class='lparen'>(</span>
    <span class='lbracket'>[</span>
      <span class='const'>OptPort</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SRVPORT</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The local port to listen on.</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>445</span> <span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='rbracket'>]</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_register_advanced_options'>register_advanced_options</span><span class='lparen'>(</span>
    <span class='lbracket'>[</span>
      <span class='const'>OptInt</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMBServerMaximumBuffer</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The maximum number of data in megabytes to buffer</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>2</span> <span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'>OptInt</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMBServerIdleTimeout</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>The maximum amount of time to keep an idle session open in seconds</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>120</span> <span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='rbracket'>]</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='rparen'>)</span>

  <span class='ivar'>@smb_server_last_pool_sweep</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='ivar'>@smb_server_pool_mutex</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='ivar'>@smb_server_request_counter</span> <span class='op'>=</span> <span class='int'>0</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="on_client_close-instance_method">
  
    - (<tt>Object</tt>) <strong>on_client_close</strong>(client) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


51
52
53</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 51</span>

<span class='kw'>def</span> <span class='id identifier rubyid_on_client_close'>on_client_close</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_smb_stop'>smb_stop</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="on_client_connect-instance_method">
  
    - (<tt>Object</tt>) <strong>on_client_connect</strong>(client) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


40
41
42
43</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 40</span>

<span class='kw'>def</span> <span class='id identifier rubyid_on_client_connect'>on_client_connect</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='comment'># print_status(&quot;New SMB connection from #{client.peerhost}:#{client.peerport}&quot;)
</span>  <span class='id identifier rubyid_smb_conn'>smb_conn</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="on_client_data-instance_method">
  
    - (<tt>Object</tt>) <strong>on_client_data</strong>(client) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


45
46
47
48
49</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 45</span>

<span class='kw'>def</span> <span class='id identifier rubyid_on_client_data'>on_client_data</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='comment'># print_status(&quot;New data from #{client.peerhost}:#{client.peerport}&quot;)
</span>  <span class='id identifier rubyid_smb_recv'>smb_recv</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="setup-instance_method">
  
    - (<tt>Object</tt>) <strong>setup</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


35
36
37
38</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 35</span>

<span class='kw'>def</span> <span class='id identifier rubyid_setup'>setup</span>
  <span class='kw'>super</span>
  <span class='ivar'>@state</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="smb_cmd_dispatch-instance_method">
  
    - (<tt>Object</tt>) <strong>smb_cmd_dispatch</strong>(cmd, c, buff) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


169
170
171
172</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 169</span>

<span class='kw'>def</span> <span class='id identifier rubyid_smb_cmd_dispatch'>smb_cmd_dispatch</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span><span class='comma'>,</span> <span class='id identifier rubyid_buff'>buff</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_smb'>smb</span> <span class='op'>=</span> <span class='ivar'>@state</span><span class='lbracket'>[</span><span class='id identifier rubyid_c'>c</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_print_status'>print_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Received command </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cmd'>cmd</span><span class='embexpr_end'>}</span><span class='tstring_content'> from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="smb_conn-instance_method">
  
    - (<tt>Object</tt>) <strong>smb_conn</strong>(c) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


55
56
57
58</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 55</span>

<span class='kw'>def</span> <span class='id identifier rubyid_smb_conn'>smb_conn</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
  <span class='ivar'>@state</span><span class='lbracket'>[</span><span class='id identifier rubyid_c'>c</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='symbol'>:name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_peerhost'>peerhost</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_peerport'>peerport</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:ip</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_peerhost'>peerhost</span><span class='comma'>,</span> <span class='symbol'>:port</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_peerport'>peerport</span><span class='rbrace'>}</span>
  <span class='id identifier rubyid_smb_pool_update'>smb_pool_update</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="smb_error-instance_method">
  
    - (<tt>Object</tt>) <strong>smb_error</strong>(cmd, c, errorclass, esn = false) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 182</span>

<span class='kw'>def</span> <span class='id identifier rubyid_smb_error'>smb_error</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span><span class='comma'>,</span> <span class='id identifier rubyid_errorclass'>errorclass</span><span class='comma'>,</span> <span class='id identifier rubyid_esn'>esn</span> <span class='op'>=</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='comment'># 0xc0000022 = Deny
</span>  <span class='comment'># 0xc000006D = Logon_Failure
</span>  <span class='comment'># 0x00000000 = Ignore
</span>  <span class='id identifier rubyid_pkt'>pkt</span> <span class='op'>=</span> <span class='const'>CONST</span><span class='op'>::</span><span class='const'>SMB_BASE_PKT</span><span class='period'>.</span><span class='id identifier rubyid_make_struct'>make_struct</span>
  <span class='id identifier rubyid_smb_set_defaults'>smb_set_defaults</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='comma'>,</span> <span class='id identifier rubyid_pkt'>pkt</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Command</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_cmd'>cmd</span>
  <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flags1</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>  <span class='op'>=</span> <span class='const'>CONST</span><span class='op'>::</span><span class='const'>FLAGS_REQ_RES</span> <span class='op'>|</span> <span class='const'>CONST</span><span class='op'>::</span><span class='const'>FLAGS_CASE_SENSITIVE</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_esn'>esn</span>
    <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flags2</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>  <span class='op'>=</span>
      <span class='const'>CONST</span><span class='op'>::</span><span class='const'>FLAGS2_UNICODE_STRINGS</span> <span class='op'>+</span>
      <span class='const'>CONST</span><span class='op'>::</span><span class='const'>FLAGS2_EXTENDED_SECURITY</span> <span class='op'>+</span>
      <span class='const'>CONST</span><span class='op'>::</span><span class='const'>FLAGS2_32_BIT_ERROR_CODES</span> <span class='op'>+</span>
      <span class='const'>CONST</span><span class='op'>::</span><span class='const'>FLAGS2_LONG_PATH_COMPONENTS</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flags2</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>  <span class='op'>=</span>
      <span class='const'>CONST</span><span class='op'>::</span><span class='const'>FLAGS2_UNICODE_STRINGS</span> <span class='op'>+</span>
      <span class='const'>CONST</span><span class='op'>::</span><span class='const'>FLAGS2_32_BIT_ERROR_CODES</span> <span class='op'>+</span>
      <span class='const'>CONST</span><span class='op'>::</span><span class='const'>FLAGS2_LONG_PATH_COMPONENTS</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ErrorClass</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_errorclass'>errorclass</span>
  <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_put'>put</span><span class='lparen'>(</span><span class='id identifier rubyid_pkt'>pkt</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="smb_pool_update-instance_method">
  
    - (<tt>Object</tt>) <strong>smb_pool_update</strong>(c) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Update the last-seen timestamp and purge old entries</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 207</span>

<span class='kw'>def</span> <span class='id identifier rubyid_smb_pool_update'>smb_pool_update</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>

  <span class='ivar'>@state</span><span class='lbracket'>[</span><span class='id identifier rubyid_c'>c</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:last_action</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
  <span class='ivar'>@smb_server_request_counter</span> <span class='op'>+=</span> <span class='int'>1</span>

  <span class='kw'>unless</span> <span class='ivar'>@smb_server_request_counter</span> <span class='op'>%</span> <span class='int'>100</span> <span class='op'>==</span> <span class='int'>0</span> <span class='op'>||</span>
    <span class='ivar'>@smb_server_last_pool_sweep</span> <span class='op'>+</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMBServerIdleTimeout</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>&lt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># Synchronize pool sweeps in case we move to threaded services
</span>  <span class='ivar'>@smb_server_pool_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_purge_list'>purge_list</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

    <span class='ivar'>@smb_server_last_pool_sweep</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>

    <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_sc'>sc</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='ivar'>@state</span><span class='lbracket'>[</span><span class='id identifier rubyid_sc'>sc</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:last_action</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMBServerIdleTimeout</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>&lt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
        <span class='id identifier rubyid_purge_list'>purge_list</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_sc'>sc</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># Purge any idle connections to rescue file descriptors
</span>    <span class='id identifier rubyid_purge_list'>purge_list</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_sc'>sc</span><span class='op'>|</span>
      <span class='id identifier rubyid_vprint_status'>vprint_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Dropping connection from </span><span class='embexpr_beg'>#{</span><span class='ivar'>@state</span><span class='lbracket'>[</span><span class='id identifier rubyid_sc'>sc</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> due to idle timeout...</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_smb_stop'>smb_stop</span><span class='lparen'>(</span><span class='id identifier rubyid_sc'>sc</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="smb_recv-instance_method">
  
    - (<tt>Object</tt>) <strong>smb_recv</strong>(c) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 74</span>

<span class='kw'>def</span> <span class='id identifier rubyid_smb_recv'>smb_recv</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_smb'>smb</span> <span class='op'>=</span> <span class='ivar'>@state</span><span class='lbracket'>[</span><span class='id identifier rubyid_c'>c</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_buff'>buff</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_buff'>buff</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_get_once'>get_once</span><span class='lparen'>(</span><span class='op'>-</span><span class='int'>1</span><span class='comma'>,</span> <span class='float'>0.25</span><span class='rparen'>)</span>
      <span class='comment'># Handle any number of errors that a read can trigger depending on socket state
</span>  <span class='kw'>rescue</span> <span class='op'>::</span><span class='const'>IOError</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>EOFError</span><span class='comma'>,</span>
    <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ECONNRESET</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOTCONN</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ECONNABORTED</span><span class='comma'>,</span>
    <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ETIMEDOUT</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENETRESET</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ESHUTDOWN</span>
    <span class='id identifier rubyid_vprint_status'>vprint_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Dropping connection from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> due to exception: </span><span class='embexpr_beg'>#{</span><span class='gvar'>$!</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='gvar'>$!</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_smb_stop'>smb_stop</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># The client said it had data, but lied, kill the session
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_buff'>buff</span> <span class='kw'>and</span> <span class='id identifier rubyid_buff'>buff</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
    <span class='id identifier rubyid_vprint_status'>vprint_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Dropping connection from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> due to empty payload...</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_smb_stop'>smb_stop</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># Append the new data to the buffer
</span>  <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_buff'>buff</span>

  <span class='comment'># Prevent a simplistic DoS if the buffer is too big
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='lparen'>(</span><span class='int'>1024</span><span class='op'>*</span><span class='int'>1024</span><span class='op'>*</span><span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMBServerMaximumBuffer</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_vprint_status'>vprint_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Dropping connection from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> due to oversized buffer of </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> bytes...</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_smb_stop'>smb_stop</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># Update the last-seen timestamp and purge old entries
</span>  <span class='id identifier rubyid_smb_pool_update'>smb_pool_update</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>

  <span class='kw'>while</span><span class='lparen'>(</span><span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span><span class='rparen'>)</span>

    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='int'>4</span>

    <span class='id identifier rubyid_plen'>plen</span> <span class='op'>=</span> <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>2</span><span class='comma'>,</span><span class='int'>2</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>n</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>

    <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='id identifier rubyid_plen'>plen</span><span class='op'>+</span><span class='int'>4</span>

    <span class='id identifier rubyid_buff'>buff</span> <span class='op'>=</span> <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:data</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_plen'>plen</span><span class='op'>+</span><span class='int'>4</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_pkt_nbs'>pkt_nbs</span> <span class='op'>=</span> <span class='const'>CONST</span><span class='op'>::</span><span class='const'>NBRAW_PKT</span><span class='period'>.</span><span class='id identifier rubyid_make_struct'>make_struct</span>
    <span class='id identifier rubyid_pkt_nbs'>pkt_nbs</span><span class='period'>.</span><span class='id identifier rubyid_from_s'>from_s</span><span class='lparen'>(</span><span class='id identifier rubyid_buff'>buff</span><span class='rparen'>)</span>

    <span class='comment'># print_status(&quot;NetBIOS request from #{smb[:name]} #{pkt_nbs.v[&#39;Type&#39;]} #{pkt_nbs.v[&#39;Flags&#39;]} #{buff.inspect}&quot;)
</span>
    <span class='comment'># Check for a NetBIOS name request
</span>    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_pkt_nbs'>pkt_nbs</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Type</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='int'>0x81</span><span class='rparen'>)</span>
      <span class='comment'># Accept any name they happen to send
</span>
      <span class='id identifier rubyid_host_dst'>host_dst</span> <span class='op'>=</span> <span class='const'>UTILS</span><span class='period'>.</span><span class='id identifier rubyid_nbname_decode'>nbname_decode</span><span class='lparen'>(</span><span class='id identifier rubyid_pkt_nbs'>pkt_nbs</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span><span class='int'>32</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[\x00\x20]+$</span><span class='regexp_end'>/n</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_host_src'>host_src</span> <span class='op'>=</span> <span class='const'>UTILS</span><span class='period'>.</span><span class='id identifier rubyid_nbname_decode'>nbname_decode</span><span class='lparen'>(</span><span class='id identifier rubyid_pkt_nbs'>pkt_nbs</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>35</span><span class='comma'>,</span><span class='int'>32</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[\x00\x20]+$</span><span class='regexp_end'>/n</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

      <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:nbdst</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_host_dst'>host_dst</span>
      <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:nbsrc</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_host_src'>host_src</span>

      <span class='comment'># print_status(&quot;NetBIOS session request from #{smb[:name]} (asking for #{host_dst} from #{host_src})&quot;)
</span>      <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x82\x00\x00\x00</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>next</span>
    <span class='kw'>end</span>


    <span class='comment'>#
</span>    <span class='comment'># TODO: Support AndX parameters
</span>    <span class='comment'>#
</span>

    <span class='comment'># Cast this to a generic SMB structure
</span>    <span class='id identifier rubyid_pkt'>pkt</span> <span class='op'>=</span> <span class='const'>CONST</span><span class='op'>::</span><span class='const'>SMB_BASE_PKT</span><span class='period'>.</span><span class='id identifier rubyid_make_struct'>make_struct</span>
    <span class='id identifier rubyid_pkt'>pkt</span><span class='period'>.</span><span class='id identifier rubyid_from_s'>from_s</span><span class='lparen'>(</span><span class='id identifier rubyid_buff'>buff</span><span class='rparen'>)</span>

    <span class='comment'># Only respond to requests, ignore server replies
</span>    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Flags1</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;</span> <span class='int'>128</span> <span class='op'>!=</span> <span class='int'>0</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_vprint_status'>vprint_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Dropping connection from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> due to missing client request flag</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_smb_stop'>smb_stop</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
      <span class='kw'>return</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_cmd'>cmd</span> <span class='op'>=</span> <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Command</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
    <span class='kw'>begin</span>
      <span class='id identifier rubyid_smb_cmd_dispatch'>smb_cmd_dispatch</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='id identifier rubyid_c'>c</span><span class='comma'>,</span> <span class='id identifier rubyid_buff'>buff</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='op'>::</span><span class='const'>Interrupt</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='gvar'>$!</span>
    <span class='kw'>rescue</span> <span class='op'>::</span><span class='const'>Exception</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
      <span class='id identifier rubyid_print_status'>print_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Error processing request from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cmd'>cmd</span><span class='embexpr_end'>}</span><span class='tstring_content'>): </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>next</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="smb_set_defaults-instance_method">
  
    - (<tt>Object</tt>) <strong>smb_set_defaults</strong>(c, pkt) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


174
175
176
177
178
179
180</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 174</span>

<span class='kw'>def</span> <span class='id identifier rubyid_smb_set_defaults'>smb_set_defaults</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='comma'>,</span> <span class='id identifier rubyid_pkt'>pkt</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_smb'>smb</span> <span class='op'>=</span> <span class='ivar'>@state</span><span class='lbracket'>[</span><span class='id identifier rubyid_c'>c</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ProcessID</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:process_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
  <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UserID</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:user_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
  <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TreeID</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:tree_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
  <span class='id identifier rubyid_pkt'>pkt</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_v'>v</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MultiplexID</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_smb'>smb</span><span class='lbracket'>[</span><span class='symbol'>:multiplex_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="smb_stop-instance_method">
  
    - (<tt>Object</tt>) <strong>smb_stop</strong>(c) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62
63
64
65
66
67
68
69
70
71
72</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/smb/server.rb', line 60</span>

<span class='kw'>def</span> <span class='id identifier rubyid_smb_stop'>smb_stop</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
  <span class='comment'># Make sure the socket is closed
</span>  <span class='kw'>begin</span>
    <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
      <span class='comment'># Handle any number of errors that a double-close or failed shutdown can trigger
</span>  <span class='kw'>rescue</span> <span class='op'>::</span><span class='const'>IOError</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>EOFError</span><span class='comma'>,</span>
    <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ECONNRESET</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENOTCONN</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ECONNABORTED</span><span class='comma'>,</span>
    <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ETIMEDOUT</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ENETRESET</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>Errno</span><span class='op'>::</span><span class='const'>ESHUTDOWN</span>
  <span class='kw'>end</span>

  <span class='comment'># Delete the state table entry
</span>  <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Tue Jan 19 22:32:26 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.1.7).
</div>

  </body>
</html>